---
title: "HW3"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(haven)
```



## Problem 2

Load and tidy demographic data. Exclude participants less than 21 years of age, and those with missing demographic data; and encode data with reasonable variable classes.

```{r}
demo_df = 
  read_csv("data/nhanes_covar.csv", 
    skip = 4,
    na = c("NA", ".", "")) |> 
  janitor::clean_names() |> 
  filter(age >= 21) |> 
  drop_na() |>
  mutate(
    sex = case_match(
      sex,
      1 ~ "male",
      2 ~ "female")) |>
  mutate(
    education = case_match(
      education,
      1 ~ "Less than high school",
      2 ~ "High school equivalent",
      3 ~ "More than high school"
    )) |>
  mutate(education = factor(education, levels = c("Less than high school", "High school equivalent", "More than high school"), ordered = TRUE))
```

Load and tidy accelerometer data

```{r}
accel_df = 
  read_csv("data/nhanes_accel.csv", 
    na = c("NA", ".", "")) |> 
  janitor::clean_names() |> 
  pivot_longer(
    min1:min1440,
    names_to = "minute",
    values_to = "mims",
    names_prefix = "min"
  ) |> 
  mutate(minute = as.numeric(minute))
```

Merge demographic and accelerometer data

```{r}
merged_df = left_join(demo_df, accel_df)
```

Producing a table for the number of men and women in each education category 

```{r}
merged_df |> 
  distinct(seqn, .keep_all = TRUE) |> 
  group_by(sex, education) |> 
  summarise(n_obs = n()) |>
  pivot_wider(
    names_from = "sex",
    values_from = "n_obs"
  )|> 
  knitr::kable()
```

The table shows that while the female and male distribution in the "Less than high school" and "More than high school" education levels are similar, there are more males than females in the "High school equivalent" level.  


Creating a visualization of the age distributions for men and women in each education category. Comment on these items.

```{r}
merged_df |> 
  distinct(seqn, .keep_all = TRUE) |> 
  ggplot(aes(x = sex, y= age, color = education))+
  geom_boxplot() +
  theme(legend.position = "bottom") +
  labs(
    title = "Distribution of age by sex and education",
    x = "Sex",
    y = "Age",
    color = "Education"
  )
```

The boxplot shows that among females, the "More than high school" education level has significantly a younger age compared to "Less than high school" and "High school equivalent" education levels. Among males, the "More than high school" education level also has significantly a younger age compared to "Less than high school" and "High school equivalent" education levels. Between the sexes, the average age of females in the "High school equivalent" education level is higher than males. 



Aggregating across minutes to create a total activity variable for each participant, then making a plot. 

```{r}
merged_df |> 
  group_by(seqn, sex, age, education) |> 
  summarise(total_activity = sum(mims)) |> 
  ggplot(aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = .5) +
  geom_smooth(se = FALSE) +
  facet_grid(~education) +
  theme(legend.position = "bottom") +
  labs(
      title = "Total Activity by Age and Sex Stratified by Education",
      x = "Age",
      y = "Total Activity per Day",
      color = "Sex"
  )
```

Total activity per day decreases with increasing age for all sexes and education levels. In the "Less than high school" education level, the total activity per day for males with age greater than 40 is higher than females. In the "High school equivalent" and "More than high school" education levels, the females have higher total activity than males. 



Making a three-panel plot that shows the 24-hour activity time courses for each education level and using color to indicate sex. 

```{r}
merged_df |> 
  group_by(sex, education, minute) |> 
  summarise(mean_activity = mean(mims)) |> 
  ggplot(aes(x = minute, y = mean_activity, color = sex)) +
  geom_point(alpha = .1) +
  geom_smooth(se = FALSE) +
  scale_x_continuous(breaks = c(0, 480, 960, 1440)) +
  theme(legend.position = "bottom") +
  facet_grid(~education) +
  labs(
    title = "24-hour Activity Time Courses by Each Education Level",
    x = "Minutes",
    y = "Mean Activity Over a Day",
    color = "Sex"
  )

```

Across all education levels and sexes, the 24-hour activity time courses were similar. The lowest mean activities were observed at approximately minute 240. Then the mean activity increases after minute 240 until approximately minute 700. Following minute 700, the mean activity decreases until the end of the day. 

Compared to "High school equivalent" and "More than high school" education levels, the "Less than high school" education level had the highest peak mean activity. 

Within the "Less than high school" education level, there were not significant differences in mean activity over a day between male and female. However, in the "High school equivalent" and "More than high school" education levels, the females had higher mean activity than males. 

